//---------------------------------------------------------------------------

#pragma hdrstop

#include "ULuaFunc.h"

//---------------------------------------------------------------------------
#pragma package(smart_init)

bool   stop 	= false;
bool   wait 	= false;
int	   debug	= 0;
int 	state	= STATE_STOP;;

extern Log 			console;
extern Analizator*	analizator;
extern USignals*		Signals;

extern u32	access_count;
extern u32	access_error;

//==============================================================================
void	access_event(bool not_error = true){

	access_count++;
	if(!not_error){
		access_error++;
        (*Signals)["Probe.Error"]->Execute("");
	}
	(*Signals)["Probe.Access"]->Execute("");
};

//==============================================================================

void  Wrap(String source, TStrings* receiver, String delimiters){

	enum TMode {lexem,delim};
	TMode mode	=	delim;
	receiver->Clear(); //?????????????

	String Lex;
	for(int i = 1; i <= source.Length(); i++){

		if(source.IsDelimiter(delimiters,i)){
			if(mode == lexem){
				receiver->Add(Lex);
				Lex = "";
			}
			mode = delim;
		}else{
			mode = lexem;
			Lex += source[i];
		}
	}
	if(mode == lexem){
		receiver->Add(Lex);
		Lex = "";
	}
};

//-----------------------------------------
HList	Wrap(String source){

	enum TMode {lexem,delim};
	TMode mode = delim;

	HList	list(true);
	list.Initialize();

	String Lex;
	for(int i = 1;i <= source.Length(); i++){
		if(source.IsDelimiter("/",i)){
			if(mode == lexem){
				list->Add(Lex);
				Lex = "";
			}
			mode = delim;
		}else{
			mode = lexem;
			Lex += source[i];
		}
	}
	if(mode == lexem){
		list->Add(Lex);
		Lex = "";
	}
	return list;
};

//-----------------------------------------
int	Return(lua_State*	lvm){

	stop = true;
	return lua_yield(lvm,0);
}

//-----------------------------------------
int	Pause(lua_State*	lvm){

	return lua_yield(lvm,0);
};

//-----------------------------------------
int	Message(lua_State*	lvm){

	String type;
	String message;
	try{
		int count = lua_gettop(lvm);
		if(count == 1){

			if(lua_isboolean(lvm,1)){

				bool a = lua_toboolean(lvm,1);
				if(a) 	message = "True";
				else	message	= "False";
			}else	message 	= lua_tostring(lvm,1);
			ShowMessage(message);

		}else if(count == 2){

			type 		= lua_tostring(lvm,2);
			message 	= lua_tostring(lvm,1);
			int t = 4;
			if(LowerCase(type) == "warning")		t = 0;
			else  if(LowerCase(type) == "error")	t = 1;
			else  if(LowerCase(type) == "inform")		t = 2;

			MessageDlg(message,TMsgDlgType(t),TMsgDlgButtons()<<mbOK,0);

		}

	}catch(...){;}

	Application->ProcessMessages();
	if(stop)	return Return(lvm);
	return 1;

};


//---------------------------------------------------------------------------
int USleep(lua_State*	lvm){

	unsigned t;
	int p = lua_tointeger(lvm,1);
	int a = p/50;
	int b = p - a*50;

	for(int i = 0; i < a; i++){

		Sleep(50);
		Application->ProcessMessages();
		if(stop)	return Return(lvm);

	}
	Sleep(b);
	return 1;
}

//==============================================================================
int 	relay		(lua_State*	lvm){

	String type;
	String message;
	try{
		int count = lua_gettop(lvm);
		if(count == 1){

			if(lua_isboolean(lvm,1) || lua_isnumber(lvm,1)){

				int a = lua_tonumber(lvm,1);
				if(a){
					analizator->set_relay(true);
					console<<"-- Режим +12В"<<endl;
				}else{
					analizator->set_relay(false);
					console<<"-- Режим +27В"<<endl;
				};
			}else{
				console<<"-- Error: Типы параметров не соответствует сигнатуре функции 'relay()'"<<endl;
				stop	= true;
			}

		}else{
			console<<"-- Error: Количество параметров не соответствует сигнатуре функции 'relay()'"<<endl;
			stop	= true;
		}

	}catch(...){;}

	Application->ProcessMessages();
	if(stop)	return Return(lvm);
	return 1;

};

//==============================================================================
int 	relay_on		(lua_State*	lvm){

	String type;
	String message;
	try{
		bool res   = analizator->set_relay(true);
		access_event(res);
		if(res){
			console<<"-- Режим +12В"<<endl;
		}else{
			console<<"Ошибка обращения к устройству"<<endl;
		}

	}catch(...){;}

	Application->ProcessMessages();
	if(stop)	return Return(lvm);
	return 1;

};

//==============================================================================
int 	relay_off		(lua_State*	lvm){

	String type;
	String message;
	try{
		bool res   = analizator->set_relay(false);
		access_event(res);
		if(res){
			console<<"-- Режим +27В"<<endl;
		}else{
			console<<"Ошибка обращения к устройству"<<endl;
		}
	}catch(...){;}

	Application->ProcessMessages();
	if(stop)	return Return(lvm);
	return 1;

};

//==============================================================================
int 	low(lua_State*	lvm){

	String type;
	String message;
	try{
		int count = lua_gettop(lvm);
		if(count == 1){

			if(lua_isnumber(lvm,1)){

				double a 	= lua_tonumber(lvm,1);
				bool res	= analizator->set_level(0,a*1000.0);	//mV
				access_event(res);
				if(res){
					console<<"-- Нижний уровень компарирования: " + FloatToStr(analizator->Level[0]/1000.0) + "В"<<endl;
				}else{
					console<<"Ошибка обращения к устройству"<<endl;
				}
			}else{
				console<<"-- Error: Типы параметров не соответствует сигнатуре функции low()"<<endl;
				stop	= true;
			}

		}else{
			console<<"Error: Количество параметров не соответствует сигнатуре функции low()"<<endl;
			stop	= true;
		}

	}catch(...){;}

	Application->ProcessMessages();
	if(stop)	return Return(lvm);
	return 1;
};

//==============================================================================
int 	hi(lua_State*	lvm){

	String type;
	String message;
	try{
		int count = lua_gettop(lvm);
		if(count == 1){

			if(lua_isnumber(lvm,1)){

				double a 	= lua_tonumber(lvm,1);
				bool res	= analizator->set_level(1,a*1000.0);	//mV
				access_event(res);
				if(res){
					console<<"-- Верхний уровень компарирования: " + FloatToStr(analizator->Level[1]/1000.0) + "В"<<endl;
				}else{
					console<<"Ошибка обращения к устройству"<<endl;
				}
			}else{
				console<<"-- Error: Типы параметров не соответствует сигнатуре функции hi()"<<endl;
				stop	= true;
			}

		}else{
			console<<"Error: Количество параметров не соответствует сигнатуре функции hi()"<<endl;
			stop	= true;
		}

	}catch(...){;}

	Application->ProcessMessages();
	if(stop)	return Return(lvm);
	return 1;
};

